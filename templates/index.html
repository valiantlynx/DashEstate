<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KKD - Real Estate Dashboard</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h3 style="text-align: center; font-size: 40px">KKD - Real Estate Dashboard</h3>
    <hr>
    <button id="clear-button">Clear All Filters</button>
    <div class="checkbox-grid">
        <!-- Built Year (Mapped to House Age) -->
        <div class="checkbox-item">
            <label for="year">Built Year</label>
            <input type="checkbox" id="year" onchange="toggleInput(event, 'year-input')">
            <div class="toggle-input-wrap">
                <input type="number" id="year-input" class="toggle-input" placeholder="Enter Built Year" min="1900" max="2030">
            </div>
        </div>
        <!-- Advertisement -->
        <div class="checkbox-item">
            <label for="advertisement">Advertisement</label>
            <input type="checkbox" id="advertisement" onchange="toggleAdvertisement(event)">
        </div>
        <!-- Size -->
        <div class="checkbox-item">
            <label for="size">Size</label>
            <input type="checkbox" id="size" onchange="toggleInput(event, 'size-input')">
            <div class="toggle-input-wrap">
                <input type="number" id="size-input" class="toggle-input" placeholder="Enter Size" min="0">
            </div>
        </div>
        <!-- Bathrooms -->
        <div class="checkbox-item">
            <label for="bathrooms">Bathrooms</label>
            <input type="checkbox" id="bathrooms" onchange="toggleInput(event, 'bathrooms-input')">
            <div class="toggle-input-wrap">
                <input type="number" id="bathrooms-input" class="toggle-input" placeholder="Enter Number of Bathrooms" min="0">
            </div>
        </div>
        <!-- Condition Rating -->
        <div class="checkbox-item">
            <label for="condition_rating">Condition Rating</label>
            <input type="checkbox" id="condition_rating" onchange="toggleInput(event, 'condition_rating-input')">
            <div class="toggle-input-wrap">
                <select id="condition_rating-input" class="toggle-input">
                    <option value="">Select Condition Rating</option>
                    {% for cond_rating in unique_values.condition_ratings %}
                    <option value="{{ cond_rating }}">{{ cond_rating }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <!-- Crime Rating -->
        <div class="checkbox-item">
            <label for="crime_rating">Crime Rating</label>
            <input type="checkbox" id="crime_rating" onchange="toggleInput(event, 'crime_rating-input')">
            <div class="toggle-input-wrap">
                <select id="crime_rating-input" class="toggle-input">
                    <option value="">Select Crime Rating</option>
                    {% for rating in unique_values.condition_ratings %}
                    <option value="{{ rating }}">{{ rating }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <!-- Public Transport Rating -->
        <div class="checkbox-item">
            <label for="public_transport_rating">Public Transport Rating</label>
            <input type="checkbox" id="public_transport_rating" onchange="toggleInput(event, 'public_transport_rating-input')">
            <div class="toggle-input-wrap">
                <select id="public_transport_rating-input" class="toggle-input">
                    <option value="">Select Public Transport Rating</option>
                    {% for rating in unique_values.condition_ratings %}
                    <option value="{{ rating }}">{{ rating }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <!-- School Rating -->
        <div class="checkbox-item">
            <label for="school_rating">School Rating</label>
            <input type="checkbox" id="school_rating" onchange="toggleInput(event, 'school_rating-input')">
            <div class="toggle-input-wrap">
                <select id="school_rating-input" class="toggle-input">
                    <option value="">Select School Rating</option>
                    {% for rating in unique_values.condition_ratings %}
                    <option value="{{ rating }}">{{ rating }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    <hr>
    <div id="predicted-price"></div>

<script>
    function toggleInput(event, inputId) {
        const input = document.getElementById(inputId);
        input.classList.toggle('show', event.target.checked);
        fetchPrediction();
    }

    function toggleAdvertisement(event) {
        // Directly trigger prediction when advertisement checkbox is toggled
        fetchPrediction();
    }

    function fetchPrediction() {
        const inputs = {};

        // Collect all active inputs
        document.querySelectorAll('.checkbox-item').forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox.checked) {
                const inputElement = item.querySelector('.toggle-input');
                if (inputElement) {
                    if (inputElement.tagName.toLowerCase() === 'input') {
                        inputs[inputElement.id.replace('-input', '')] = inputElement.value || null;
                    } else if (inputElement.tagName.toLowerCase() === 'select') {
                        inputs[inputElement.id.replace('-input', '')] = inputElement.value || null;
                    }
                } else if (checkbox.id === 'advertisement') {
                    // Set 'premium' if advertisement is checked
                    inputs['advertisement'] = true;
                }
            } else {
                if (checkbox.id === 'advertisement') {
                    // Set 'regular' if advertisement is unchecked
                    inputs['advertisement'] = false;
                }
            }
        });

        fetch('/predict', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(inputs)
        })
            .then(response => response.json())
            .then(data => {
                if (data.price) {
                    const formattedPrice = data.price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                    document.getElementById('predicted-price').innerHTML = `<div style="text-align: center; font-size: 40px">Estimated Price: ${formattedPrice}</div>`;
                } else if (data.error) {
                    document.getElementById('predicted-price').innerHTML = `<div style="text-align: center; font-size: 24px; color: red;">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('predicted-price').innerHTML = `<div style="text-align: center; font-size: 24px; color: red;">An error occurred while fetching the prediction.</div>`;
            });
    }

    document.getElementById('clear-button').addEventListener('click', () => {
        const checkedElements = document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked');
        checkedElements.forEach(checkbox => {
            checkbox.checked = false;
            const checkboxItem = checkbox.closest('.checkbox-item');
            if (checkboxItem) checkboxItem.classList.add('blink');
        });

        document.querySelectorAll('.toggle-input').forEach(input => {
            input.value = '';
            input.classList.remove('show');
        });

        fetchPrediction();

        setTimeout(() => {
            const elements = document.querySelectorAll('.blink');
            elements.forEach(el => el.classList.remove('blink'));
        }, 500);
    });

    // Add event listeners to inputs that should trigger prediction
    document.querySelectorAll('.checkbox-item input[type="number"], .checkbox-item select').forEach(el => {
        el.addEventListener('input', fetchPrediction);
    });

    document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(el => {
        el.addEventListener('change', fetchPrediction);
    });
</script>
</body>
</html>
